<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>校園請假憑證發行端 - RWD全功能Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://unpkg.com/lottie-web@5.10.2/build/player/lottie.min.js"></script>
    <style>
      body {
        background: linear-gradient(120deg, #e7f0fe 0%, #fffbe6 100%);
        font-family: "Noto Sans TC", sans-serif;
        transition: 0.4s;
      }
      body.theme-dark {
        background: linear-gradient(
          120deg,
          #191d24 0%,
          #2f2a36 100%
        ) !important;
        color: #ffe082 !important;
      }
      .vc-card {
        background: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 0.8rem 2.2rem 0 #b8d2df44;
        max-width: 98vw;
        width: 440px;
        margin: clamp(10px, 7vw, 54px) auto 38px auto;
        padding: clamp(13px, 6vw, 38px);
        min-height: 450px;
        position: relative;
        z-index: 3;
        transition: 0.4s;
      }
      body.theme-dark .vc-card {
        background: #22282c;
        color: #fde99c;
      }
      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5em;
      }
      .header-main {
        font-size: 2.15rem;
        font-weight: 700;
        text-align: center;
        letter-spacing: 3px;
        transition: 0.4s;
        flex: 1;
      }
      .header-dark {
        color: #226b9a;
      }
      .header-light {
        color: #ffd600;
      }
      .header-sub {
        font-size: 0.96rem;
        color: #888;
        text-align: center;
        margin-bottom: 16px;
      }
      body.theme-dark .header-sub {
        color: #ffe082;
      }
      .theme-switch {
        min-width: 62px;
      }
      .theme-switch input {
        display: none;
      }
      .theme-switch label {
        cursor: pointer;
        padding: 6px 14px;
        border-radius: 13px;
        background: #23283d;
        border: 1.5px solid #ffd600;
        font-weight: 700;
        user-select: none;
        transition: 0.2s;
        font-size: 0.97rem;
        min-width: 50px;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        color: #ffd600;
      }
      body.theme-dark .theme-switch label {
        background: #e7f4ff;
        color: #226b9a;
        border-color: #226b9a;
      }
      .tab-nav {
        display: flex;
        justify-content: flex-start;
        overflow-x: auto;
        gap: 10px;
        font-size: 1.07rem;
        margin-bottom: 9px;
        flex-wrap: nowrap;
        border-bottom: 1.5px solid #eef;
      }
      .tab-nav::-webkit-scrollbar {
        display: none;
      }
      .tab-btn {
        background: none;
        border: none;
        color: #777;
        padding: 0.57em 1.1em;
        border-radius: 8px;
        font-weight: 600;
        letter-spacing: 1px;
        white-space: nowrap;
        text-align: center;
        min-width: 88px;
        max-width: 160px;
        transition: 0.3s;
        font-size: 1rem;
        margin-bottom: 0;
      }
      .tab-btn.active,
      .tab-btn:focus {
        background: #e0edf8;
        color: #226b9a;
        border: 1.5px solid #ffc107;
        box-shadow: 0 2px 8px #ffe9b3;
      }
      body.theme-dark .tab-btn.active,
      body.theme-dark .tab-btn:focus {
        background: #2d3244;
        color: #ffe082;
        border-color: #ffe082;
      }
      @media (max-width: 600px) {
        .tab-btn {
          min-width: 68px;
          max-width: 109px;
          padding: 7px 10px;
          font-size: 0.97em;
          margin-right: 8px !important;
        }
        .tab-nav {
          gap: 10px;
          padding-right: 18px;
        }
        .vc-card {
          width: 99vw;
          min-height: unset;
          padding: 14px 7vw 15px 7vw;
        }
        .header-main {
          font-size: 1.22rem;
        }
        .stepper {
          gap: 7px;
        }
        .cid-highlight {
          font-size: 0.97rem;
        }
        .faq-btn {
          top: 8px;
          left: 8px;
        }
      }
      .stepper {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 9px;
        gap: 14px;
      }
      .stepper-step {
        width: 27px;
        height: 27px;
        border-radius: 50%;
        background: #e0edf8;
        color: #226b9a;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.13rem;
        border: 2px solid #e0edf8;
        transition: 0.2s;
      }
      .stepper-step.active {
        background: #fff;
        border-color: #ffc107;
        color: #b07913;
        box-shadow: 0 2px 7px #ffe9b3;
      }
      body.theme-dark .stepper-step {
        background: #35373b;
        color: #ffe082;
        border-color: #34343b;
      }
      body.theme-dark .stepper-step.active {
        background: #22292e;
        border-color: #ffe082;
        color: #ffe082;
      }
      .stepper-line {
        font-size: 1.1rem;
        color: #b8d2df;
        margin: 0 4px;
      }
      body.theme-dark .stepper-line {
        color: #38373d;
      }

      .qrcode-area {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .qrcode-area img {
        max-width: 220px;
        min-width: 110px;
        box-shadow: 0 2px 18px #bbd7e7;
        border-radius: 1vw;
        background: #f1f8fe;
        border: 5px solid #fffde7;
        transition: 0.3s;
        animation: popQ 0.73s cubic-bezier(0.23, 1.25, 0.48, 0.82);
        display: block;
        margin: auto;
      }
      @keyframes popQ {
        from {
          transform: scale(0.6) rotate(-8deg);
          opacity: 0;
        }
        to {
          transform: none;
          opacity: 1;
        }
      }
      body.theme-dark .qrcode-area img {
        background: #3d4146;
        border-color: #444;
      }
      .scan-hint {
        font-size: 1.08rem;
        color: #ff9800;
        text-align: center;
        margin-bottom: 9px;
        font-weight: 600;
      }
      .vc-meta {
        background: #e7f4ff;
        border-radius: 12px;
        padding: 13px;
        color: #356;
        font-size: 1rem;
        margin-bottom: 8px;
        line-height: 1.63;
        border-left: 4px solid #ffc107;
        text-align: center;
        word-break: break-all;
      }
      body.theme-dark .vc-meta {
        background: #28292a;
        color: #ffe082;
        border-left: 4px solid #ffd600;
      }
      .cid-highlight {
        font-size: 1.13rem;
        font-weight: 700;
        color: #aa7c1b;
        letter-spacing: 1px;
        background: linear-gradient(90deg, #fff3cd 10%, #fffde7 90%);
        border-radius: 10px;
        padding: 7px 12px;
        display: inline-block;
        margin: 4px 0 10px 0;
        transition: 0.3s;
        box-shadow: 0 3px 22px #ffe08222;
      }
      body.theme-dark .cid-highlight {
        background: linear-gradient(90deg, #463e13 10%, #665400 90%);
        color: #ffc107;
      }
      .faq-pop {
        background: #fffbe8;
        border-radius: 12px;
        box-shadow: 0 2px 16px #fce6aa99;
        padding: 18px 16px;
        position: fixed;
        top: 14vh;
        left: 50%;
        transform: translateX(-50%);
        min-width: 220px;
        max-width: 95vw;
        font-size: 1rem;
        z-index: 99;
        border: 2px solid #ffe082;
        color: #666;
        display: none;
      }
      .faq-pop.active {
        display: block;
      }
      body.theme-dark .faq-pop {
        background: #2d3244;
        color: #ffd600;
        border-color: #ffd600;
      }
      .faq-btn {
        background: none;
        border: none;
        font-size: 1.33rem;
        color: #ffc107;
        z-index: 100;
        position: absolute;
        top: 13px;
        left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="vc-card" id="VCApp">
      <div class="header-row">
        <!-- 亮色時顯示暗icon/字，暗色時顯示亮icon/字 -->
        <div
          class="header-main header-dark"
          id="mainTitle"
          style="display: flex; align-items: center; gap: 10px"
        >
          <i class="fa-solid fa-moon" id="iconDark"></i>
          <span>校園請假憑證</span>
        </div>
        <div class="theme-switch">
          <input type="checkbox" id="themeToggler" />
          <label for="themeToggler"
            ><i class="fa-solid fa-sun" id="iconLight"></i>亮</label
          >
        </div>
      </div>
      <div class="header-sub">Campus Leave Certificate - 發行端</div>
      <div class="tab-nav mb-2">
        <button class="tab-btn active" onclick="tabSwitch('issue')">
          <i class="fa-solid fa-certificate"></i>憑證發行
        </button>
        <button class="tab-btn" onclick="tabSwitch('history')">
          <i class="fa-solid fa-clock-rotate-left"></i>發行紀錄
        </button>
        <button class="tab-btn" onclick="tabSwitch('help')">
          <i class="fa-solid fa-circle-info"></i>說明FAQ
        </button>
      </div>
      <div class="stepper mb-2" id="stepper-wrap">
        <div id="step1" class="stepper-step active">1</div>
        <div class="stepper-line">—</div>
        <div id="step2" class="stepper-step">2</div>
        <div class="stepper-line">—</div>
        <div id="step3" class="stepper-step">3</div>
      </div>
      <div id="step-content" class="fade-in"></div>
      <button class="faq-btn" id="faqBtn" onclick="showFaqPop()">
        <i class="fa-solid fa-circle-question"></i>
      </button>
      <div class="faq-pop" id="faqPop">
        <b>常見問題 FAQ</b><br />
        <ul>
          <li>如何領取請假憑證？<br />填寫表單並掃描QRcode即可。</li>
          <li>憑證領取後 CID 有何用途？<br />可用於校方查驗真偽。</li>
          <li>可以補領/撤銷嗎？<br />需由學校/醫院申請重發或撤銷。</li>
          <li>若失敗或遺漏，重新操作即可。</li>
        </ul>
        <button
          class="btn btn-outline-primary btn-sm w-100 mt-1"
          onclick="hideFaqPop()"
        >
          關閉FAQ
        </button>
      </div>
    </div>
    <script>
      // 暗亮模式動態title/icon調整
      function applyThemeChange(isDark) {
        let title = document.getElementById("mainTitle");
        let iconDark = document.getElementById("iconDark");
        let iconLight = document.getElementById("iconLight");
        if (isDark) {
          document.body.classList.add("theme-dark");
          title.classList.remove("header-dark");
          title.classList.add("header-light");
          iconDark.style.display = "none";
          iconLight.style.display = "inline-block";
        } else {
          document.body.classList.remove("theme-dark");
          title.classList.remove("header-light");
          title.classList.add("header-dark");
          iconDark.style.display = "inline-block";
          iconLight.style.display = "none";
        }
      }
      document.getElementById("themeToggler").onchange = function (e) {
        applyThemeChange(e.target.checked);
      };
      // 一開始default亮色icon（moon顯示、sun隱藏）
      document.addEventListener("DOMContentLoaded", () => {
        applyThemeChange(false);
      });
      function showFaqPop() {
        document.getElementById("faqPop").classList.add("active");
      }
      function hideFaqPop() {
        document.getElementById("faqPop").classList.remove("active");
      }
      let pollingInterval = null,
        currentTransactionId = null;
      let cid = "",
        currentTab = "issue";
      const historyItems = [
        { date: "2025/11/01", sid: "A12345678", status: "成功" },
        { date: "2025/10/28", sid: "B987654", status: "已撤銷" },
        { date: "2025/10/23", sid: "X13322132", status: "成功" },
      ];
      function setActiveStep(s) {
        for (let i = 1; i <= 3; i++) {
          document
            .getElementById("step" + i)
            .classList.toggle("active", i === s);
        }
      }
      tabSwitch("issue");
      function tabSwitch(tab) {
        currentTab = tab;
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.toggle(
            "active",
            btn.textContent.includes(
              tab === "issue" ? "憑證" : tab === "history" ? "紀錄" : "FAQ"
            )
          );
        });
        document.getElementById("stepper-wrap").style.display =
          tab === "issue" ? "flex" : "none";
        document.getElementById("faqBtn").style.display =
          tab === "help" ? "none" : "inline-block";
        switch (tab) {
          case "issue":
            renderStep1();
            break;
          case "history":
            renderHistory();
            break;
          case "help":
            renderHelp();
            break;
        }
      }
      function renderStep1() {
        setActiveStep(1);
        document.getElementById("step-content").innerHTML = `
      <form id="vcForm" class="fade-in">
        <div class="mb-3">
          <label for="studentId" class="form-label">學號 <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="studentId" required pattern="^[A-Za-z0-9]+$" title="僅允許英數字">
        </div>
        <div class="mb-3">
          <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="name" required pattern="^[\\u4e00-\\u9fa5A-Za-z0-9_]+$" title="僅允許中英文、數字與底線">
        </div>
        <div class="mb-3">
          <label for="className" class="form-label">班級 <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="className" required pattern="^[\\u4e00-\\u9fa5]+$" title="僅允許中文">
        </div>
        <button type="submit" class="btn btn-primary w-100">送出產生憑證 QRCode</button>
      </form>
      <div id="form-alert" class="mt-2"></div>`;
        document.getElementById("vcForm").onsubmit = function (event) {
          event.preventDefault();
          const studentId = document.getElementById("studentId").value.trim();
          const name = document.getElementById("name").value.trim();
          const className = document.getElementById("className").value.trim();
          document.getElementById(
            "form-alert"
          ).innerHTML = `<div class="alert alert-info mt-2 text-center">產生中...</div>`;
          fetch("/api/generate-vc", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              student: studentId,
              name,
              class: className,
            }),
          })
            .then((res) => res.json())
            .then((result) => {
              if (result.success) {
                currentTransactionId = result.transactionId;
                renderStep2(
                  studentId,
                  name,
                  className,
                  result.qrCode,
                  result.transactionId
                );
              } else {
                showFormAlert(
                  "憑證發行失敗：" + (result.error || "未知錯誤"),
                  false
                );
              }
            })
            .catch(() => {
              showFormAlert("伺服器未回應，請檢查後端。", false);
            });
        };
      }
      function showFormAlert(msg, isSuccess) {
        document.getElementById(
          "form-alert"
        ).innerHTML = `<div class="alert alert-${
          isSuccess ? "success" : "danger"
        }">${msg}</div>`;
      }
      function renderStep2(studentId, name, className, qrCode, transactionId) {
        setActiveStep(2);
        document.getElementById("step-content").innerHTML = `
        <div class="alert alert-success text-center fade-in mb-2">表單送出成功，請使用數位皮夾 App 掃描 QR Code 領取憑證！</div>
        <div class="qrcode-area fade-in">
          <img alt="QRCode" src="${
            qrCode.startsWith("data:image/png;base64,")
              ? qrCode
              : "data:image/png;base64," + qrCode
          }">
        </div>
        <div class="vc-meta fade-in">
          <div>學號：<b>${studentId}</b></div>
          <div>姓名：<b>${name}</b></div>
          <div>班級：<b>${className}</b></div>
        </div>
        <div id="polling-status" class="mt-2 mb-3 text-secondary text-center fade-in">等待學生掃描領取憑證...</div>
        <div class="d-grid"><button class="btn btn-outline-secondary btn-sm w-100 mt-1" onclick="renderStep1()">← 重新操作</button></div>
      `;
        startPolling();
      }
      function renderStep3(cid) {
        setActiveStep(3);
        document.getElementById("step-content").innerHTML = `
        <div class="alert alert-success text-center fade-in mb-2">憑證發送成功，學生已領取！</div>
        <div class="cid-highlight fade-in">CID：${cid}</div>
        <div class="vc-meta fade-in" id="cidCopyZone">
          <span class="me-2">複製憑證ID到剪貼簿</span>
          <button class="btn btn-warning btn-sm" onclick="copyCID('${cid}')">複製</button>
        </div>
        <div class="d-grid"><button class="btn btn-primary w-100 mt-2" onclick="renderStep1()">發行下一張憑證</button></div>
      `;
      }
      function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);
        if (!currentTransactionId) return;
        pollingInterval = setInterval(() => {
          fetch(`/api/poll-transaction?transactionId=${currentTransactionId}`)
            .then((res) => res.json())
            .then((data) => {
              if (data.received === true) {
                clearInterval(pollingInterval);
                renderStep3(data.cid || "（查無CID）");
              }
            });
        }, 3000);
      }
      function copyCID(cid) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(cid);
          document
            .getElementById("cidCopyZone")
            .insertAdjacentHTML(
              "beforeend",
              `<span style="color:#29b56a;font-size:.97rem;margin-left:8px;">已複製！</span>`
            );
          setTimeout(
            () =>
              document.querySelector("#cidCopyZone span:last-child").remove(),
            1200
          );
        }
      }
      function renderHistory() {
        document.getElementById(
          "step-content"
        ).innerHTML = `<div class="vc-meta fade-in" style="text-align:left;">
          <i class="fa-solid fa-clock-rotate-left me-2"></i><b>發行紀錄：</b>
          <ul style="list-style:square;padding-left:2.3vw;margin-bottom:0;">
            ${historyItems
              .map(
                (item) =>
                  `<li><b>${item.date}</b> 學號${item.sid} <span style="color:${
                    item.status == "成功" ? "#29b56a" : "#ca2222"
                  }">${item.status}</span></li>`
              )
              .join("")}
          </ul>
        </div>
        <div style="font-size:.99rem;color:#888;margin-top:1.8vw;text-align:center;">僅顯示近期發行記錄</div>`;
      }
      function renderHelp() {
        document.getElementById(
          "step-content"
        ).innerHTML = `<div class="vc-meta fade-in" style="text-align:left;">
          <i class="fa-solid fa-circle-info me-2"></i><b>常見問題 FAQ</b><br>
          <ul style="padding-left:2.3vw;margin-top:0.8vw;">
            <li><b>如何領取請假憑證？</b><br>填寫表單並掃描QRcode即可。</li>
            <li><b>CID有何用途？</b><br>可用於校方查驗真偽。</li>
            <li><b>如何補領/撤銷？</b><br>校方/醫院可重發或撤銷。</li>
            <li><b>失敗或遺漏怎麼辦？</b><br>重新操作即可。</li>
          </ul>
        </div>
        <div style="font-size:.99rem;color:#888;margin-top:1.8vw;text-align:center;">更多詳情請洽校證發行處或客服</div>`;
      }
    </script>
  </body>
</html>
