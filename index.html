<form id="vcForm">
  <div class="mb-3">
    <label for="studentId" class="form-label">學號 <span class="text-danger">*</span></label>
    <input type="text" class="form-control" id="studentId" required pattern="^[A-Za-z0-9]+$" title="僅允許英數字">
  </div>
  <div class="mb-3">
    <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
    <input type="text" class="form-control" id="name" required pattern="^[\u4e00-\u9fa5A-Za-z0-9_]+$" title="僅允許中英文、數字與底線">
  </div>
  <div class="mb-3">
    <label for="className" class="form-label">班級 <span class="text-danger">*</span></label>
    <input type="text" class="form-control" id="className" required pattern="^[\u4e00-\u9fa5]+$" title="僅允許中文">
  </div>
  <button type="submit" class="btn btn-primary w-100">送出產生 QRCode</button>
</form>

<script>
  document.getElementById("vcForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const studentId = document.getElementById("studentId").value;
    const name = document.getElementById("name").value;
    const className = document.getElementById("className").value;

    fetch("/api/generate-vc", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        student: studentId,
        name: name,
        class: className
      })
    })
    .then(res => res.json())
    .then(result => {
      if(result.success) {
        let html = '<div class="alert alert-success">憑證發行成功！</div>';
        if (result.qrCode) {
          let src = result.qrCode.startsWith("data:image/png;base64,")
            ? result.qrCode
            : "data:image/png;base64," + result.qrCode;
          html += '<div class="mt-3"><img src="' + src + '" alt="QRCode"></div>';
        }
        document.getElementById("result").innerHTML = html;
      } else {
        document.getElementById("result").innerHTML =
          '<div class="alert alert-danger">憑證發行失敗：' + (result.error || '未知錯誤') + '</div>';
      }
    })
    .catch(() => {
      document.getElementById("result").innerHTML =
        '<div class="alert alert-danger">伺服器未回應，請檢查後端。</div>';
    });
  });
</script>
