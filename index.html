<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>校園請假憑證發行端</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #e7f0fe 0%, #fffbe6 100%);
      min-height: 100vh;
    }
    .vc-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 24px 0 #b8d2df44;
      max-width: 440px;
      margin: 50px auto 0 auto;
      padding: 38px 28px 20px 28px;
      font-family: 'Noto Sans TC', sans-serif;
    }
    .header-main {
      font-size: 2.2rem;
      font-weight: 700;
      color: #226b9a;
      text-align: center;
      letter-spacing: 3px;
      margin-bottom: 2px;
    }
    .header-sub {
      font-size: .95rem;
      color: #888;
      text-align: center;
      margin-bottom: 15px;
    }
    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      gap: 10px;
    }
    .stepper-step {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #e0edf8;
      color: #226b9a;
      font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      border: 2.5px solid #e0edf8;
      transition: 0.3s;
    }
    .stepper-step.active {
      background: #fff;
      border-color: #ffc107;
      color: #b07913;
      box-shadow: 0 2px 10px #ffe9b3;
    }
    .stepper-line {
      font-size:1.5rem; color:#b8d2df;
      margin: 0 5px;
    }
    .qrcode-area img {
      max-width: 220px;
      margin: 0 auto 8px auto;
      box-shadow: 0 2px 12px #BBD7E7;
      border-radius: 10px;
    }
    .vc-meta {
      background: #e7f4ff;
      border-radius: 14px;
      padding: 15px 14px;
      color: #356;
      font-size: 1.1rem;
      margin-bottom:10px;
      line-height: 1.7;
      border-left: 4px solid #ffc107;
      font-family: 'Noto Sans TC', sans-serif;
    }
    .cid-highlight {
      font-size: 1.35rem;
      font-weight: 700;
      color: #aa7c1b;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #fff3cd 10%, #fffde7 90%);
      border-radius: 10px;
      padding: 8px 14px;
      display: inline-block;
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .fade-in { animation: fadeIn .8s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px);} to {opacity: 1; transform: none;} }
  </style>
</head>
<body>
  <div class="vc-card">
    <div class="header-main">校園請假憑證</div>
    <div class="header-sub">Campus Leave Certificate - 發行端</div>
    <div class="stepper mb-4">
      <div id="step1" class="stepper-step active">1</div>
      <div class="stepper-line">—</div>
      <div id="step2" class="stepper-step">2</div>
      <div class="stepper-line">—</div>
      <div id="step3" class="stepper-step">3</div>
    </div>
    <div id="step-content" class="fade-in"></div>
  </div>
  <script>
    let step = 1;
    let pollingInterval = null;
    let currentTransactionId = null;
    let cid = ''; // 憑證ID

    renderStep1();

    function setActiveStep(s) {
      step = s;
      for(let i = 1; i <= 3; i++) {
        document.getElementById('step'+i).classList.toggle('active', i === s);
      }
    }

    function renderStep1() {
      setActiveStep(1);
      document.getElementById("step-content").innerHTML = `
        <form id="vcForm" class="fade-in">
          <div class="mb-3">
            <label for="studentId" class="form-label">學號 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="studentId" required pattern="^[A-Za-z0-9]+$" title="僅允許英數字">
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" required pattern="^[\u4e00-\u9fa5A-Za-z0-9_]+$" title="僅允許中英文、數字與底線">
          </div>
          <div class="mb-3">
            <label for="className" class="form-label">班級 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="className" required pattern="^[\u4e00-\u9fa5]+$" title="僅允許中文">
          </div>
          <button type="submit" class="btn btn-primary w-100">送出產生憑證 QRCode</button>
        </form>
        <div id="form-alert" class="mt-2"></div>
      `;

      document.getElementById("vcForm").onsubmit = function(event) {
        event.preventDefault();
        const studentId = document.getElementById("studentId").value.trim();
        const name = document.getElementById("name").value.trim();
        const className = document.getElementById("className").value.trim();

        fetch("/api/generate-vc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ student: studentId, name, class: className })
        })
        .then(res => res.json())
        .then(result => {
          if(result.success) {
            currentTransactionId = result.transactionId;
            renderStep2(studentId, name, className, result.qrCode, result.transactionId);
          } else {
            showFormAlert('憑證發行失敗：' + (result.error || '未知錯誤'), false);
          }
        })
        .catch(() => {
          showFormAlert('伺服器未回應，請檢查後端。', false);
        });
      }
    }

    function renderStep2(studentId, name, className, qrCode, transactionId) {
      setActiveStep(2);
      document.getElementById("step-content").innerHTML = `
        <div class="alert alert-success text-center fade-in mb-2">表單送出成功，請使用數位皮夾 App 掃描 QR Code 領取憑證！</div>
        <div class="qrcode-area fade-in">
          <img alt="QRCode" src="${qrCode.startsWith("data:image/png;base64,") ? qrCode : "data:image/png;base64," + qrCode}">
        </div>
        <div class="vc-meta fade-in">
          <div>學號：<b>${studentId}</b></div>
          <div>姓名：<b>${name}</b></div>
          <div>班級：<b>${className}</b></div>
        </div>
        <div id="polling-status" class="mt-2 mb-3 text-secondary text-center fade-in">等待學生掃描領取憑證...</div>
        <div class="d-grid"><button class="btn btn-outline-secondary btn-sm w-100 mt-1" onclick="renderStep1()">← 重新操作</button></div>
      `;
      startPolling();
    }

    function renderStep3(cid) {
      setActiveStep(3);
      document.getElementById("step-content").innerHTML = `
        <div class="alert alert-success text-center fade-in mb-2">憑證發送成功，學生已領取！</div>
        <div class="cid-highlight fade-in">CID：${cid}</div>
        <div class="vc-meta fade-in" id="cidCopyZone">
          <span class="me-2">複製憑證ID到剪貼簿</span>
          <button class="btn btn-warning btn-sm" onclick="copyCID('${cid}')">複製</button>
        </div>
        <div class="d-grid"><button class="btn btn-primary w-100 mt-2" onclick="renderStep1()">發行下一張憑證</button></div>
      `;
    }

    function showFormAlert(msg, isSuccess) {
      document.getElementById("form-alert").innerHTML = `<div class="alert alert-${isSuccess ? "success" : "danger"}">${msg}</div>`;
    }

    function startPolling() {
      if(pollingInterval) clearInterval(pollingInterval);
      if(!currentTransactionId) return;
      pollingInterval = setInterval(() => {
        fetch(`/api/poll-transaction?transactionId=${currentTransactionId}`)
          .then(res => res.json())
          .then(data => {
            if (data.received === true) {
              clearInterval(pollingInterval);
              renderStep3((data.cid || '（查無CID）'));
            }
          });
      }, 3000);
    }

    function copyCID(cid) {
      if(navigator.clipboard) {
        navigator.clipboard.writeText(cid);
        document.getElementById("cidCopyZone").insertAdjacentHTML('beforeend',
          `<span style="color:#29b56a;font-size:.95rem;margin-left:8px;">已複製！</span>`);
        setTimeout(()=>document.querySelector("#cidCopyZone span:last-child").remove(), 1200);
      }
    }
  </script>
</body>
</html>
